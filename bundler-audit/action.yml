name: "Bundler Audit"
description: "Run bundler-audit security check and comment on PR"

inputs:
  github_token:
    description: "GitHub token for PR comments"
    required: true

runs:
  using: 'composite'
  steps:
    - name: Install bundler-audit
      run: gem install bundler-audit
      shell: bash

    - name: Run bundler-audit
      run: |
        if bundle exec bundler-audit check --update; then
          echo "âœ… No security vulnerabilities found!" > audit_results.txt
        else
          echo "âš ï¸ Security vulnerabilities detected:" > audit_results.txt
          echo "" >> audit_results.txt
          bundle exec bundler-audit check --update 2>&1 | \
          awk '/^Name:/,/^Vulnerabilities found!/' | \
          grep -E "^(Name:|Version:|Criticality:|Title:)" | \
          awk '
          BEGIN { name=""; version=""; criticality=""; title="" }
          /^Name:/ { name=$2 }
          /^Version:/ { version=$2 }
          /^Criticality:/ { criticality=$2 }
          /^Title:/ { 
            title=substr($0, 8)  # Remove "Title: " prefix
            printf "- **%s v%s** (%s) - %s\n", name, version, criticality, title
          }' >> audit_results.txt
          exit 1
        fi
      shell: bash

    - name: Handle PR comments
      uses: actions/github-script@v7
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      with:
        script: |
          const fs = require('fs');
          const auditResults = fs.readFileSync('audit_results.txt', 'utf8');
          const hasVulnerabilities = auditResults.includes('âš ï¸ Security vulnerabilities detected:');
          
          // Find existing bundler-audit comment
          const comments = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const existingComment = comments.data.find(comment => 
            comment.body.includes('ğŸ” Bundler Audit Results') && 
            comment.user.type === 'Bot'
          );
          
          if (hasVulnerabilities) {
            // Create or update comment with vulnerabilities
            const comment = `## ğŸ” Bundler Audit Results\n\n${auditResults}`;
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
          } else if (existingComment) {
            // Update existing comment to show resolved
            await github.rest.issues.updateComment({
              comment_id: existingComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ğŸ” Bundler Audit Results\n\nâœ… Security issues resolved!'
            });
          }
